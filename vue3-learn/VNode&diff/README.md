# Vue2 vs Vue3

## Vue3 vnode & diff ä¼˜åŒ–
`vue3`çš„`compile`å°†`template`è½¬æ¢æˆ`render`å‡½æ•°ï¼ŒåŒ…å«`vnode`ç”Ÿæˆå‡½æ•°

å…·ä½“å‚è€ƒ[Vue3ç¼–è¯‘](../Vue3ç¼–è¯‘/README.md)

`vue3`çš„æ¸²æŸ“æå‡äº†å¾ˆå¤šï¼Œ`upadte`æ€§èƒ½æå‡`1.3~2`å€ï¼Œ`ssr`æå‡`2~3`å€

### vnode
å‚è€ƒ[Vue3ç¼–è¯‘](../Vue3ç¼–è¯‘/README.md)

`vdom`å°±æ˜¯ç”¨ä¸€ä¸ª`jså¯¹è±¡`å»æè¿°`nodeèŠ‚ç‚¹`çš„ä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘


```js
let vdom = {
  type: "div",  // æ ‡ç­¾ç±»å‹
  props: {id: "app"}, // æ ‡ç­¾å±æ€§
  children: ["hello"] // æ ‡ç­¾å­å†…å®¹
}
```
`vdom`ä¼˜åŠ¿ï¼š
åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œåªéœ€è¦å°†æ—§çš„`vnode`å’Œæ›´æ–°åçš„`vnode`åšä¸€ä¸ª`diff`è¿ç®—ï¼ˆå¯¹æ¯”ï¼‰ï¼Œæ‰¾å‡ºæœ€å°çš„ä¿®æ”¹éƒ¨åˆ†ï¼Œæœ€åé‡æ–°æ¸²æŸ“è¯¥éƒ¨åˆ†å³å¯å¤§å¤§**æé«˜æ›´æ–°é€Ÿåº¦å’ŒèŠ‚çœæ€§èƒ½å¼€æ”¯**

[vnodeæºç ](https://github.com/vuejs/vue-next/blob/cf2f278f48e21ff8e2a325c09eb0c7ab5bf5a1f4/packages/runtime-core/src/vnode.ts#L291)

`vue3`å¯¹äº`vnode`çš„æ›´æ–°
- **åŠ¨æ€æ ‡è®°**ï¼šåœ¨åˆ›å»ºæ—¶åŒºåˆ†é™æ€ä¸åŠ¨æ€ï¼Œé™æ€ä¸ä¼šè¢«`diff`
- **èŠ‚ç‚¹ç±»å‹åˆ†ç±»**ï¼šæ ‡è®°åŠ¨æ€èŠ‚ç‚¹çš„åŠ¨æ€å±æ€§ç±»å‹ï¼Œ`diff`ä¸ç”¨éå†å…¨éƒ¨å±æ€§
- **äº‹ä»¶ç¼“å­˜**

#### é™æ€æ ‡è®°
åœ¨`vue2`çš„æ—¶å€™å·²ç»å­˜åœ¨é™æ€æ ‡è®°äº†ï¼Œä½†æ˜¯ä»ç„¶ä¼šå­˜åœ¨æµªè´¹æ€§èƒ½çš„æƒ…å†µï¼Œå› ä¸ºåœ¨`diff`çš„æ—¶å€™ï¼Œå®ƒä¼šéå†æ•´ä¸ª`vnode`

![](./vnode2.6.png)

è€Œ`vue3`åˆ™æ˜¯åœ¨åˆ›å»º`vnode`çš„æ—¶å€™ï¼Œå°±æŠŠåŠ¨æ€èŠ‚ç‚¹æ ‡è®°å‡ºæ¥ï¼Œè¿™æ ·åœ¨`diff`è¿‡ç¨‹ä¸­åªéœ€è¦æ¯”è¾ƒæ ‡è®°å‡ºæ¥çš„èŠ‚ç‚¹å³å¯ï¼Œè€Œæ— éœ€å†æŠŠå…¶ä»–é™æ€èŠ‚ç‚¹éå†ä¸€é

å‚è€ƒåœ¨çº¿`vue3`çš„`compile`å‡ºæ¥çš„`render`å‡½æ•°[vue3 template explorer](https://vue-next-template-explorer.netlify.app/#%7B%22src%22%3A%22%3Cdiv%20id%3D%5C%22app%5C%22%3E%5Cn%20%20%3Cdiv%3EHello%20World%3C%2Fdiv%3E%5Cn%20%20%3Cdiv%3E%7B%7Bname%7D%7D%3C%2Fdiv%3E%5Cn%3C%2Fdiv%3E%22%2C%22ssr%22%3Afalse%2C%22options%22%3A%7B%22mode%22%3A%22module%22%2C%22prefixIdentifiers%22%3Afalse%2C%22optimizeBindings%22%3Afalse%2C%22hoistStatic%22%3Afalse%2C%22cacheHandlers%22%3Afalse%2C%22scopeId%22%3Anull%7D%7D)
![](./render1.png)
å®ƒçš„`ast`:
![](https://user-gold-cdn.xitu.io/2020/4/22/1719fd770ba11208?imageslim)
çœ‹åˆ°åœ¨`ast`ä¸Šå­˜åœ¨`dynamicChildren`æ•°ç»„ï¼Œè¿™å°±æ˜¯åŠ¨æ€èŠ‚ç‚¹æ•°ç»„ï¼Œè€Œ`vue2`ä¸­æ˜¯æ²¡æœ‰çš„


#### èŠ‚ç‚¹ç±»å‹ç»†åˆ†
[vue3 template explorer](https://vue-next-template-explorer.netlify.app/#%7B%22src%22%3A%22%3Cdiv%20id%3D%5C%22app%5C%22%3E%5Cn%20%20%3Cdiv%3EHello%20World%3C%2Fdiv%3E%5Cn%20%20%3Cdiv%3E%7B%7Bname%7D%7D%3C%2Fdiv%3E%5Cn%3C%2Fdiv%3E%22%2C%22ssr%22%3Afalse%2C%22options%22%3A%7B%22mode%22%3A%22module%22%2C%22prefixIdentifiers%22%3Afalse%2C%22optimizeBindings%22%3Afalse%2C%22hoistStatic%22%3Afalse%2C%22cacheHandlers%22%3Afalse%2C%22scopeId%22%3Anull%7D%7D)
![](./render.png)
`_createVNode`å‡½æ•°åªæœ‰å½“ç¬¬å››ä¸ªå‚æ•°å­˜åœ¨æ—¶ï¼Œæ‰ä¼šå°†å…¶æ ‡è®°ä¸ºåŠ¨æ€èŠ‚ç‚¹ï¼Œå¹¶ä¸”ç¬¬å››ä¸ªå‚æ•°æ˜¯ä¸åŒçš„
`vue3`ç”¨`patchFlag`è¡¨ç¤ºèŠ‚ç‚¹åŠ¨æ€ç±»å‹ï¼Œä¸åŒçš„ç±»å‹ç”¨ä¸åŒæ•°å­—è¡¨ç¤º
```js
export const enum PatchFlags {
  // è¿™é‡Œçš„æ•°å­—èµ‹å€¼éƒ½é‡‡ç”¨ä½è¿ç®—ï¼Œæ•°å­—éƒ½æ˜¯äºŒè¿›åˆ¶è¡¨ç¤º
  TEXT = 1, // 1 - è¡¨ç¤ºå…·æœ‰åŠ¨æ€textContentçš„å…ƒç´ 
  CLASS = 1 << 1, // 10 - è¡¨ç¤ºæœ‰åŠ¨æ€Classçš„å…ƒç´ 
  STYLE = 1 << 2, // 100 - è¡¨ç¤ºåŠ¨æ€æ ·å¼ï¼ˆé™æ€å¦‚style="color: red"ï¼Œä¹Ÿä¼šæå‡è‡³åŠ¨æ€ï¼‰
  PROPS = 1 << 3, // 1000 - è¡¨ç¤ºå…·æœ‰éç±»/æ ·å¼åŠ¨æ€é“å…·çš„å…ƒç´ ã€‚
  FULL_PROPS = 1 << 4, // 10000 - è¡¨ç¤ºå¸¦æœ‰åŠ¨æ€é”®çš„é“å…·çš„å…ƒç´ ï¼Œä¸ä¸Šé¢ä¸‰ç§ç›¸æ–¥
  HYDRATE_EVENTS = 1 << 5, // 100000 - è¡¨ç¤ºå¸¦æœ‰äº‹ä»¶ç›‘å¬å™¨çš„å…ƒç´ 
  STABLE_FRAGMENT = 1 << 6, // è¡¨ç¤ºå…¶å­é¡ºåºä¸å˜çš„ç‰‡æ®µï¼ˆæ²¡æ‡‚ï¼‰ã€‚ 
  KEYED_FRAGMENT = 1 << 7, // è¡¨ç¤ºå¸¦æœ‰é”®æ§æˆ–éƒ¨åˆ†é”®æ§å­å…ƒç´ çš„ç‰‡æ®µã€‚
  UNKEYED_FRAGMENT = 1 << 8, // è¡¨ç¤ºå¸¦æœ‰æ— keyç»‘å®šçš„ç‰‡æ®µ
  NEED_PATCH = 1 << 9, // è¡¨ç¤ºåªéœ€è¦éå±æ€§è¡¥ä¸çš„å…ƒç´ ï¼Œä¾‹å¦‚refæˆ–hooks
  DYNAMIC_SLOTS = 1 << 10, // è¡¨ç¤ºå…·æœ‰åŠ¨æ€æ’æ§½çš„å…ƒç´ 
  HOISTED = -1, // é™æ€æå‡
  BAIL = -2 
}
```
[patchFlags æºç ](https://github.com/vuejs/vue-next/blob/cf2f278f48e21ff8e2a325c09eb0c7ab5bf5a1f4/packages/shared/src/patchFlags.ts)

å¦‚æœå½“åŒä¸€ä¸ªèŠ‚ç‚¹çš„åŠ¨æ€ç±»å‹è¶…è¿‡ä¸¤ä¸ªï¼Œè¿™é‡Œå°±ç”¨ä½è¿ç®—æ¥ç»„åˆç±»å‹æ˜¾ç¤ºæ•°å­—
![](./render3.png)
ğŸŒ°ï¼š åŒæ—¶æ‹¥æœ‰`id`å’Œ`text`å±æ€§ï¼Œå°±æ˜¯äºŒè¿›åˆ¶`1` + `1000`ï¼Œè½¬åŒ–ä¸ºåè¿›åˆ¶å°±æ˜¯`9`

è¿™æ ·æ ‡è®°äº†ä»¥åï¼Œ`ast`ä¸Šä¼šå‡ºç°`patchFlag`æ ‡è®°åŠ¨æ€èŠ‚ç‚¹ç±»å‹ï¼Œ`dynamicProps`è®°å½•åŠ¨æ€å±æ€§`key`
![](https://user-gold-cdn.xitu.io/2020/4/22/1719fe1243172c9d?imageslim)
è¿™æ ·åœ¨`diff`è¿ç®—çš„æ—¶å€™ï¼Œåªéœ€æ ¹æ®è®°å½•çš„`patchFlag`å’Œ`dynamicProps`å»å¯»æ‰¾å¯¹åº”çš„`props`è¿›è¡Œåˆ¤æ–­å³å¯ï¼Œæ— éœ€å†éå†ä¸€éæ‰€æœ‰çš„`props`

##### é™æ€æå‡
å¯ä»¥çœ‹åˆ°`PatchFlags`å¯¹è±¡é‡Œæœ‰ä¸€ä¸ª
```js
// ...
  HOISTED = -1, // é™æ€æå‡
// ...
```
![](./render4.png)
å½“å­˜åœ¨å¤§é‡çš„é™æ€èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨å°†å…¶è½¬åŒ–ä¸ºä¸€ä¸ªé™æ€èŠ‚ç‚¹ï¼Œå¹¶ç”¨å­—ç¬¦ä¸²çš„å½¢å¼æ¥ä¿å­˜ï¼Œä»¥æ­¤æ¥èŠ‚çº¦å†…å­˜ï¼Œæé«˜æ€§èƒ½

#### äº‹ä»¶ç¼“å­˜
åŸå…ˆç»‘å®šäº‹ä»¶çš„æ—¶å€™ï¼Œç®­å¤´å‡½æ•°çš„`$event => ...`å³ä½¿æ¯æ¬¡å†…å®¹æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯å…¨æ–°çš„`function`ï¼Œæ‰€ä»¥ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“æ‰§è¡Œä¸€æ¬¡
![](./render5.1.png)
å¼€å¯`cacheHandlers`å
![](./render5.2.png)
ä½¿ç”¨äº†ç¼“å­˜`cache[1]`æ¥ä¿å­˜ç®­å¤´å‡½æ•°ï¼Œè¿™æ ·å¦‚æœç®­å¤´å‡½æ•°æ²¡æœ‰æ”¹åŠ¨ï¼Œå°±å¯ä»¥åˆ¤å®šæ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œé¿å…äº†ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“

### diff 
[æºç ](https://github.com/vuejs/vue-next/blob/cf2f278f48e21ff8e2a325c09eb0c7ab5bf5a1f4/packages/runtime-core/src/renderer.ts#L1544)

@å¾…ç»­ã€‚ã€‚ã€‚

## å‚è€ƒ
[å°¤é›¨æºªç›´æ’­ä¸­æåˆ° vue3.0 diff ç®—æ³•ä¼˜åŒ–ç»†èŠ‚](https://juejin.im/post/5e9ee8a6f265da47b27da28c)
[å°¤å¤§Vue3.0ç›´æ’­è™šæ‹ŸDomæ€»ç»“(å’ŒReactå¯¹æ¯”)](https://juejin.im/post/5e9faa8fe51d4546fe263eda)